// ==== Globals ====
String irmenuItems[] = {"recv ir", "ir list"};
int irMenuIndex = 0;
bool inIrSubmenu = false;
#define MAX_IR_RAW_LEN 1024
char irLastIRRaw[MAX_IR_RAW_LEN];
char irBuffer[256];
String irRawData = "";
char irInfo[6][32];        // كل سطر من البيانات


int irFileIndex = 0;
String irFileList[20];
int irFileCount = 0;


// ==== Show Message ====
void showMessage(String msg) {
  u8g2.clearBuffer();
  u8g2.setCursor(0, 20);
  u8g2.print(msg);
  u8g2.sendBuffer();
}


void recvIR() {
 static const unsigned char image_hizmos_oled_bits[] U8X8_PROGMEM = {0x40,0x88,0x81,0x01,0x03,0xe0,0x9c,0x81,0x01,0x03,0xe0,0xdc,0xc3,0x83,0x07,0xa0,0xd4,0xff,0xff,0x07,0xf8,0xff,0xff,0xff,0x07,0x0c,0x00,0x00,0x00,0x08,0x0a,0x00,0x00,0x00,0x10,0xc9,0x00,0x00,0x00,0x13,0xc9,0x00,0x00,0x00,0x13,0x09,0x00,0x55,0x00,0x10,0x09,0x00,0x00,0x00,0x10,0xc9,0xf1,0xff,0x87,0x1e,0x29,0x0a,0x00,0x08,0x1e,0x89,0x08,0x00,0x88,0x1e,0xc9,0x09,0x00,0x08,0x1e,0xe9,0x0b,0x00,0x88,0x1e,0x09,0x08,0x00,0x08,0x1e,0x09,0x08,0x00,0x88,0x1e,0x09,0x08,0x00,0x08,0x1e,0x09,0x08,0x00,0x88,0x1e,0x09,0x08,0x00,0x08,0x1e,0x09,0xf0,0xff,0x87,0x1e,0x09,0x00,0x00,0x00,0x1e,0x09,0x00,0x22,0x80,0x1e,0x09,0x00,0x3e,0x00,0x10,0x09,0x00,0x22,0x38,0x10,0x09,0x00,0x2a,0x38,0x10,0x09,0x00,0x22,0x38,0x10,0x09,0x00,0x3e,0x00,0x10,0x09,0x00,0x22,0x00,0x10,0x09,0x88,0x80,0x08,0x10,0x09,0xf8,0xbe,0x0f,0x10,0x09,0x88,0xa2,0x08,0x10,0x09,0xa8,0xaa,0x0a,0x10,0x09,0x88,0xa2,0x08,0x10,0x09,0xf8,0xbe,0x0f,0x10,0x09,0x88,0x80,0x08,0x10,0x09,0x00,0x3e,0x00,0x10,0x09,0x00,0x22,0x1f,0x10,0x09,0x00,0x2a,0x11,0x10,0x09,0x00,0x22,0x15,0x10,0x09,0x00,0x3e,0x11,0x10,0x09,0x00,0x22,0x1f,0x10,0x09,0x00,0x00,0x00,0x10,0x09,0x00,0x00,0x00,0x10,0x09,0x00,0x00,0x00,0x10,0x09,0x00,0x00,0x00,0x10,0x09,0x00,0x00,0x00,0x10,0xc9,0x00,0x00,0x00,0x13,0xc9,0x00,0x3c,0x00,0x13,0x09,0x00,0x42,0x00,0x10,0x0a,0x00,0x42,0x00,0x08,0xfc,0xff,0xff,0xff,0x07};


    u8g2.clearBuffer();
    u8g2.setFontMode(1);
    u8g2.setBitmapMode(1);
    // hizmos_oled
    u8g2.drawXBMP(86, 5, 37, 53, image_hizmos_oled_bits);

    // Layer 2
    u8g2.setFont(u8g2_font_profont12_tr);
    u8g2.drawStr(2, 12, "point remote ");

    // Layer 3
    u8g2.drawStr(1, 42, "then press ");

    // Layer 4
    u8g2.drawStr(2, 56, "a button ");

    // Layer 5
    u8g2.drawStr(29, 26, "");

    // Layer 6
    u8g2.drawStr(1, 28, "toward device");

    u8g2.sendBuffer();


  if (digitalRead(BTN_BACK) == LOW) {
        delay(200);
        while(digitalRead(BTN_BACK) == LOW);
        inIrSubmenu = false;
        
        return;
      }

  if (IrReceiver.decode()) {


    static const unsigned char image_DolphinReadingSuccess_bits[] U8X8_PROGMEM = {0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x80,0xff,0x0f,0x20,0x40,0x00,0x00,0x00,0x70,0x00,0x70,0x10,0x20,0x00,0x00,0x00,0x0c,0x00,0x80,0x11,0x10,0x00,0x00,0x00,0x03,0x00,0x00,0x02,0x08,0x00,0x00,0x80,0x00,0x00,0x00,0x04,0x04,0x00,0x00,0x40,0x00,0x00,0x00,0x08,0x02,0x00,0x00,0x20,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x20,0x80,0x03,0x00,0x08,0x00,0x00,0x00,0x40,0x70,0x00,0x00,0x08,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x04,0x00,0x0f,0x00,0x80,0x00,0x7f,0x00,0x02,0xc0,0x30,0x00,0x80,0xe0,0x80,0x00,0x02,0x20,0x7e,0x00,0x00,0x19,0x00,0x01,0x01,0x90,0xff,0x00,0x00,0x07,0x00,0x02,0x01,0x90,0xf3,0x00,0x00,0x01,0x00,0x02,0x01,0xc8,0xe3,0x01,0xc0,0x00,0xf0,0x02,0x01,0xc8,0xe3,0x01,0x30,0x00,0xfc,0x03,0x01,0xc8,0xff,0x01,0x0c,0x00,0xfe,0x01,0x00,0xc8,0xff,0x01,0x02,0x00,0xff,0x01,0x00,0x9a,0xff,0x00,0x00,0x80,0xff,0x00,0x00,0x95,0xff,0x00,0x00,0xc0,0x7f,0x00,0x80,0x2a,0x7e,0x00,0x00,0xe0,0x3f,0x00,0x00,0xd5,0x7f,0x00,0x00,0xf0,0x1f,0x00,0x80,0xaa,0x81,0x01,0x00,0xf8,0x0f,0x00,0x00,0x55,0x00,0x02,0x00,0xfc,0x07,0x00,0x80,0x2a,0x00,0x00,0x00,0xfe,0x03,0x00,0x00,0x15,0x00,0x00,0x00,0xff,0x01,0x00,0x00,0x0a,0x00,0x00,0xc0,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0xf8,0x07,0x00,0x00,0x00,0x10,0x00,0x3c,0x60,0xfd,0x00,0x00,0x00,0x20,0x00,0x1f,0x80,0xab,0x03,0x00,0x00,0xc0,0xe0,0x1f,0x00,0x56,0x07,0x00,0x00,0x00,0xff,0x3f,0x00,0xa8,0x07,0x00,0x00,0x00,0x00,0xfe,0xff,0x7f,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,0xf8,0x03,0x00,0x00,0x00,0x00,0x00,0xf8,0x0f,0x00,0x00,0x00,0x00,0x00,0xc0,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0xa0,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x40,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x80,0xfe,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x55,0x15,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0x1a,0x00,0x00,0x00,0x00,0x00,0x00,0x54,0x15,0x00,0x00,0x00,0x00,0x00,0x00,0xa8,0x2a,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x21,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00};
static const unsigned char image_KeyBackspaceSelected_bits[] U8X8_PROGMEM = {0xfe,0x7f,0xff,0xff,0xef,0xff,0xe7,0xff,0x03,0xc0,0xe7,0xff,0xef,0xff,0xff,0xff,0xfe,0x7f};
static const unsigned char image_KeySaveSelected_bits[] U8X8_PROGMEM = {0xfe,0xff,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xcf,0x68,0xf3,0x77,0x6b,0xed,0x6f,0x6b,0xe1,0x5f,0x6b,0xfd,0xe7,0x98,0xf3,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,0xff,0x7f};
static const unsigned char image_Untitled_bits[] U8X8_PROGMEM = {0xfe,0xff,0xff,0xff,0x01,0xc7,0xff,0xdf,0xff,0x03,0xbb,0xff,0xdf,0xff,0x03,0xfb,0xff,0xdf,0xef,0x03,0xfb,0x19,0xc7,0xc7,0x03,0xc7,0xd6,0xda,0x83,0x03,0xbf,0xd0,0xda,0x01,0x03,0xbf,0xde,0xda,0x00,0x02,0xbb,0xde,0xda,0xff,0x03,0xc7,0xd9,0xc6,0xff,0x03,0xfe,0xff,0xff,0xff,0x01};



static const unsigned char image_download_bits[] U8X8_PROGMEM = {0x00,0x00,0x00,0x00,0x00,0xff,0x1f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x7c,0x00,0x04,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x83,0x01,0x04,0x00,0x00,0x00,0xf0,0x0b,0x00,0x80,0x00,0x02,0x08,0x00,0x00,0x00,0x0c,0x0c,0x00,0x40,0xfc,0x04,0x08,0x00,0x00,0x00,0x02,0x30,0x00,0x40,0xf2,0x05,0x10,0x00,0x00,0x00,0x02,0xc0,0x00,0x20,0xe1,0x0b,0x10,0x00,0x00,0x00,0x01,0x00,0x03,0x20,0xe1,0x0b,0x10,0x00,0x00,0x00,0x01,0x00,0x0c,0x20,0xf3,0x0b,0x10,0x00,0x00,0x00,0xf9,0x00,0x30,0x20,0xff,0x0b,0x10,0x00,0x00,0x00,0x05,0x03,0xc0,0xa0,0xff,0x0b,0x10,0x00,0x00,0x00,0x03,0x0c,0x00,0x60,0xf8,0x07,0x20,0x00,0x00,0x00,0x02,0x10,0x00,0x10,0xe0,0x05,0x20,0x00,0x00,0x00,0x02,0x60,0x00,0x00,0xc0,0x02,0x20,0x00,0x00,0x0e,0x04,0x80,0x00,0x00,0x80,0x01,0x20,0x00,0x00,0x11,0x04,0x00,0x03,0x00,0x80,0x00,0x20,0x00,0x00,0x11,0x08,0x00,0x04,0x00,0x01,0x00,0x20,0x00,0x80,0x10,0x10,0x00,0x18,0x00,0x01,0x00,0x20,0x00,0x80,0x10,0x20,0x00,0x20,0x80,0x00,0x00,0x20,0x00,0xf8,0x10,0xc0,0x00,0xc0,0x40,0x00,0x00,0x20,0x00,0x04,0x11,0x80,0x01,0x00,0x3f,0x00,0x00,0x20,0x00,0x02,0x12,0x00,0x03,0x00,0x00,0x00,0x00,0x20,0x00,0x02,0x12,0x00,0x0f,0x00,0x00,0x00,0x00,0x20,0x00,0x01,0x12,0x00,0x1f,0x00,0x00,0x00,0x00,0x10,0x00,0x01,0x12,0x80,0x7f,0x00,0x00,0x00,0x00,0x10,0x00,0x01,0x22,0x40,0xfd,0x03,0x1c,0x00,0x00,0x10,0x00,0x01,0x41,0x30,0xfd,0x3f,0x22,0x00,0x00,0x30,0x00,0x01,0x81,0x0c,0xf9,0x0f,0x22,0x00,0x00,0x70,0x00,0x82,0x00,0x03,0xf1,0x01,0x21,0x00,0x00,0xd0,0x00,0x46,0x00,0x02,0x01,0x00,0x21,0x00,0x00,0xb0,0x01,0x3c,0x00,0x00,0x01,0xf0,0x21,0x00,0x00,0x50,0x03,0x08,0x00,0x80,0x00,0x08,0x22,0x00,0x00,0xa0,0x02,0x08,0x00,0x80,0x00,0x04,0x40,0x00,0x00,0x60,0x05,0x10,0x00,0x80,0x00,0x04,0x40,0x00,0x00,0xe0,0x06,0x10,0x00,0x80,0x00,0x02,0x80,0x01,0x00,0x40,0x0d,0x20,0x00,0xa2,0x00,0x02,0x00,0x06,0x00,0xc0,0x0a,0x40,0x00,0x80,0x00,0x02,0x00,0x18,0x00,0x80,0x15,0x80,0x8a,0xaa,0x00,0x02,0x00,0xe0,0x00,0x80,0x1a,0x00,0x01,0x80,0x00,0x02,0x00,0x00,0x07,0x00,0x35,0x00,0xaa,0xaa,0x00,0x04,0x00,0x00,0x18,0x00,0x2b,0x00,0x54,0xd0,0x00,0x08,0x00,0x00,0x20,0x00,0x55,0x00,0xa8,0xaa,0x00,0x30,0x00,0x00,0x00,0x00,0x6b,0x00,0x70,0x55,0x01,0xc0,0x00,0x00,0x00,0x00,0xd6,0x00,0xc0,0xaa,0x01,0x80,0x01,0x00,0x00,0x00,0xaa,0x00,0x00,0xff,0x01,0x80,0x03,0x00,0x00,0x00,0xd6,0x00,0x00,0x00,0x01,0x80,0x0f,0x00,0x00,0x00,0xaa,0x00,0x00,0x00,0x01,0x00,0x3f,0x00,0x00,0x00,0xd6};













  
   uint32_t hex = IrReceiver.decodedIRData.decodedRawData;
uint16_t addr = IrReceiver.decodedIRData.address;
uint16_t cmd = IrReceiver.decodedIRData.command;
uint8_t bits = IrReceiver.decodedIRData.numberOfBits;
uint8_t rawlen = IrReceiver.decodedIRData.rawDataPtr->rawlen;
const char* type = IrReceiver.getProtocolString();

// تحويل الأرقام إلى نصوص
char addrStr[10];
char cmdStr[10];
sprintf(addrStr, "%04X", addr);  // HEX
sprintf(cmdStr, "%04X", cmd);    // HEX

u8g2.clearBuffer();
u8g2.setFontMode(1);
u8g2.setBitmapMode(1);

// DolphinReadingSuccess
u8g2.drawXBMP(0, 0, 59, 63, image_DolphinReadingSuccess_bits);

// Layer 3
u8g2.setFont(u8g2_font_haxrcorp4089_tr);
u8g2.drawStr(72, 42, "c:");

// Layer 4
u8g2.drawStr(72, 29, "a:");

// نوع البروتوكول
u8g2.setFont(u8g2_font_profont15_tr);
u8g2.drawStr(81, 15, type);

// عرض الـ address
u8g2.setFont(u8g2_font_haxrcorp4089_tr);
u8g2.drawStr(81, 29, addrStr);

// عرض الـ command
u8g2.drawStr(81, 43, cmdStr);

// الأيقونات السفلية
u8g2.drawXBMP(49, 53, 24, 11, image_KeySaveSelected_bits);         // KeySaveSelected
u8g2.drawXBMP(0, 54, 16, 9, image_KeyBackspaceSelected_bits);      // KeyBackspaceSelected
u8g2.drawXBMP(94, 53, 34, 11, image_Untitled_bits);                // Untitled

u8g2.sendBuffer();


    








    irRawData = "";
    for (uint8_t i = 1; i < rawlen; i++) {
      irRawData += String(IrReceiver.decodedIRData.rawDataPtr->rawbuf[i] * MICROS_PER_TICK);
      if (i < rawlen - 1) irRawData += ",";
    }

    IrReceiver.resume();

    while (true) {
      if (digitalRead(BTN_BACK) == LOW) return;

      if (digitalRead(BTN_SELECT) == LOW) {
        delay(200);


      if (digitalRead(BTN_BACK) == LOW) {
        delay(200);
        while(digitalRead(BTN_BACK) == LOW);
        inIrSubmenu = false;
        
        return;
      }
      // بقية الأزرار كالسابق...
    

        while (digitalRead(BTN_SELECT) == LOW);
        String name = inputName();
        if (name != "") {
          File f = SD.open("/" + name + ".ir", FILE_WRITE);
          if (f) {
            f.println(irRawData);
            f.close();
            static const unsigned char image_DolphinSaved_bits[] U8X8_PROGMEM = {0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0xff,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x0e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x80,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0xc0,0x07,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x30,0x18,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0xbf,0x00,0x00,0x08,0x20,0x80,0x00,0x00,0x00,0x00,0x00,0xc0,0xc0,0x00,0x00,0xc4,0x4f,0x80,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x03,0x00,0x24,0x5f,0x00,0x01,0x00,0x00,0x00,0x00,0x20,0x00,0x0c,0x00,0x12,0xbe,0x00,0x01,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x12,0xbe,0x00,0x01,0x00,0x00,0x00,0x00,0x10,0x00,0xc0,0x00,0x32,0xbf,0x00,0x01,0x00,0x00,0x00,0x00,0x90,0x0f,0x00,0x03,0xf2,0xbf,0x00,0x01,0x00,0x00,0x00,0x00,0x50,0x30,0x00,0x0c,0xfa,0xbf,0x00,0x01,0x00,0x00,0x00,0x00,0x30,0xc0,0x00,0x00,0x86,0x7f,0x00,0x02,0x00,0x00,0x00,0x00,0x20,0x00,0x01,0x00,0x01,0x5e,0x00,0x02,0x00,0xff,0x3f,0x00,0x20,0x00,0x06,0x00,0x00,0x2c,0x00,0x02,0x00,0x1f,0x70,0x00,0x40,0x00,0x08,0x00,0x00,0x18,0x00,0x02,0x00,0x1f,0xf6,0x00,0x40,0x00,0x30,0x00,0x00,0x08,0x00,0x02,0x00,0x1f,0xf6,0x01,0x80,0x00,0x40,0x00,0x10,0x00,0x00,0x02,0x00,0x1f,0xf6,0x01,0x00,0x01,0x80,0x01,0x10,0x00,0x00,0x02,0x00,0x1f,0xf0,0x01,0x00,0x02,0x00,0x02,0x08,0x00,0x00,0x02,0x00,0xff,0xff,0x01,0x00,0x0c,0x00,0x0c,0x04,0x00,0x00,0x02,0x00,0xff,0xff,0x01,0x00,0x18,0x00,0xf0,0x03,0x00,0x00,0x02,0x00,0xff,0xff,0x01,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0xff,0xff,0x01,0x00,0xf0,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x07,0xc0,0x01,0x00,0xf0,0x01,0x00,0x00,0x00,0x00,0x01,0x00,0xe7,0xcf,0x07,0x00,0xfc,0x07,0x00,0x00,0x00,0x00,0x01,0x00,0x07,0xc0,0x39,0x00,0xd3,0x3f,0x00,0x00,0x00,0x00,0x01,0x00,0xe7,0xcf,0xc1,0xe1,0xd0,0xff,0x83,0x03,0x00,0x00,0x03,0x00,0x07,0xc0,0x01,0x1e,0x90,0xff,0x40,0x04,0x00,0x00,0x07,0x00,0x07,0xc0,0x01,0x00,0x10,0x1f,0x40,0x04,0x00,0x00,0x0d,0x00,0xff,0xff,0x01,0x00,0x10,0x00,0x20,0x04,0x00,0x00,0x1b,0x00,0x00,0x04,0x00,0x00,0x10,0x00,0x20,0x04,0x00,0x00,0x35,0x00,0x00,0x08,0x00,0x00,0x08,0x00,0x3e,0x04,0x00,0x00,0x2a,0x00,0x00,0x10,0x00,0x00,0x08,0x00,0x41,0x04,0x00,0x00,0x56,0x00,0x00,0x20,0x00,0x00,0x08,0x80,0x00,0x08,0x00,0x00,0x6e,0x00,0x00,0x40,0x00,0x00,0x08,0x80,0x00,0x08,0x00,0x00,0xd4,0x00,0x00,0x80,0x01,0x20,0x0a,0x40,0x00,0x30,0x00,0x00,0xac,0x00,0x00,0x00,0x02,0x00,0x08,0x40,0x00,0xc0,0x01,0x00,0x58,0x01,0x00,0x00,0xac,0xa8,0x0a,0x40,0x00,0x00,0x0e,0x00,0xa8,0x01,0x00,0x00,0x18,0x00,0x08,0x40,0x00,0x00,0x70,0x00,0x50,0x03,0x00,0x00,0xa0,0xaa,0x0a,0x40,0x00,0x00,0x80,0x01,0xb0,0x02,0x00,0x00,0xc0,0x05,0x0d,0x80,0x00,0x00,0x00,0x02,0x50,0x05,0x00,0x00,0x00,0xab,0x0a,0x00,0x01,0x00,0x00,0x00,0xb0,0x06,0x00,0x00,0x00,0x5c,0x15,0x00,0x06,0x00,0x00,0x00,0x60,0x0d,0x00,0x00,0x00,0xe0,0x1a,0x00,0x18,0x00,0x00,0x00,0xa0,0x0a,0x00,0x00,0x00,0x00,0x1f,0x00,0x38,0x00,0x00,0x00,0x60,0x0d,0x00,0x00,0x00,0x00,0x10,0x00,0xf8,0x00,0x00,0x00,0xa0,0x0a,0x00,0x00,0x00,0x00,0x10,0x00,0xf0,0x03,0x00,0x00,0x60,0x0d};
static const unsigned char image_FILLED_bits[] U8X8_PROGMEM = {0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff};


    u8g2.clearBuffer();
    u8g2.setFontMode(1);
    u8g2.setBitmapMode(1);
    // FILLED
    u8g2.drawXBMP(0, 0, 128, 64, image_FILLED_bits);

    // DolphinSaved
    u8g2.setDrawColor(2);
    u8g2.drawXBMP(36, 6, 92, 58, image_DolphinSaved_bits);

    // Layer 3
    u8g2.setFont(u8g2_font_haxrcorp4089_tr);
    u8g2.drawStr(9, 17, "SAVED!");

    u8g2.sendBuffer();


          } else {
            runLoop(drawnosdcard);
          }
        } else {
          showMessage("Invalid Name");
        }
        delay(1000);
        return;
      }

      if (digitalRead(BTN_UP) == LOW) {
        replayRaw(irRawData);
    u8g2.clearBuffer();
    u8g2.setFontMode(1);
    u8g2.setBitmapMode(1);
    // download
    u8g2.drawXBMP(48, 5, 80, 58, image_download_bits);

    // Layer 2
    u8g2.setFont(u8g2_font_profont12_tr);
    u8g2.drawStr(5, 30, "replayed");

    // Layer 3
    u8g2.setFont(u8g2_font_profont15_tr);
    u8g2.drawStr(8, 14, "signal");

    u8g2.sendBuffer();
        
        delay(2000);
        return;
      }
    }
  }
}


String inputName() {
  const char* keys[] = {
    "<","A","B","C","D","E","F","G",
    "H","I","J","K","L","M","N","O",
    "P","Q","R","S","T","U","V","W",
    "X","Y","Z","0","1","2","3","4",
    "5","6","7","8","9","-","_","*",
    "/","@","#",".",",","ENTER"
  };

  const int totalKeys = sizeof(keys) / sizeof(keys[0]); // 46
  const int cols = 8;
  const int rows = (totalKeys + cols - 1) / cols; // = 6
  const int visibleRows = 3;
  const int maxNameLen = 10;

  int offsetY = 0;
  int cursorX = 0, cursorY = 0;
  String name = "";

  const char charset[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  for (int i = 0; i < 6; i++) name += charset[random(strlen(charset))];

  while (true) {
    u8g2.clearBuffer();
    u8g2.setFont(u8g2_font_6x12_tf);

    // Draw name
    u8g2.drawStr(0, 10, "NAME:");
    u8g2.drawStr(42, 10, name.c_str());

    // Draw keys
    for (int y = 0; y < visibleRows; y++) {
      for (int x = 0; x < cols; x++) {
        int keyIndex = (offsetY + y) * cols + x;
        if (keyIndex >= totalKeys) continue;

        int boxX = x * 16;
        int boxY = 14 + y * 16;

        const char* key = keys[keyIndex];
        int boxW = (strcmp(key, "ENTER") == 0) ? 30 : 14;

        if (x == cursorX && y == cursorY) {
          u8g2.drawBox(boxX, boxY, boxW, 14);
          u8g2.setDrawColor(0);
          u8g2.setCursor(boxX + 2, boxY + 11);
          u8g2.print(key);
          u8g2.setDrawColor(1);
        } else {
          u8g2.drawFrame(boxX, boxY, boxW, 14);
          u8g2.setCursor(boxX + 2, boxY + 11);
          u8g2.print(key);
        }
      }
    }

    u8g2.sendBuffer();

    // Controls
    if (digitalRead(BTN_UP) == LOW) {
      if (cursorY == 0 && offsetY > 0) {
        offsetY--;
      } else if (cursorY > 0) {
        cursorY--;
      }
      delay(150);
    }

    if (digitalRead(BTN_DOWN) == LOW) {
      if ((cursorY + offsetY + 1) * cols + cursorX < totalKeys && cursorY < visibleRows - 1) {
        cursorY++;
      } else if (offsetY + visibleRows < rows) {
        offsetY++;
      }
      delay(150);
    }

    if (digitalRead(BTN_LEFT) == LOW) {
      if (cursorX > 0) cursorX--;
      delay(150);
    }

    if (digitalRead(BTN_RIGHT) == LOW) {
      if ((offsetY + cursorY) * cols + cursorX + 1 < totalKeys && cursorX < cols - 1) cursorX++;
      delay(150);
    }

    if (digitalRead(BTN_SELECT) == LOW) {
      int keyIndex = (cursorY + offsetY) * cols + cursorX;
      if (keyIndex < totalKeys) {
        const char* key = keys[keyIndex];
        if (strcmp(key, "<") == 0) {
          if (name.length() > 0) name.remove(name.length() - 1);
        } else if (strcmp(key, "ENTER") == 0) {
          return name;
        } else {
          if (name.length() < maxNameLen) name += key;
        }
      }
      delay(200);
    }

    if (digitalRead(BTN_BACK) == LOW) {
      return ""; // Cancel input
    }
  }
}





void saveRawToFile() {
  String filename = inputName();  // من غير أي باراميتر

  if (filename == "") return;

  String fullpath = "/" + filename + ".ir";
  File f = SD.open(fullpath, FILE_WRITE);
  if (f) {
    f.println(irLastIRRaw);
    f.close();

    u8g2.clearBuffer();
    u8g2.setCursor(0, 30);
    u8g2.print("Saved as:");
    u8g2.setCursor(0, 45);
    u8g2.print(filename);
    u8g2.sendBuffer();
    delay(1000);
  } else {
    u8g2.clearBuffer();
    u8g2.setCursor(0, 30);
    u8g2.print("Save Failed!");
    u8g2.sendBuffer();
    delay(1000);
  }
}




// ==== Replay IR ====
void replayRaw(String data) {
  const int maxLen = 200;
  uint16_t raw[maxLen];
  int index = 0;

  char buf[data.length() + 1];
  data.toCharArray(buf, sizeof(buf));
  char *token = strtok(buf, ",");
  while (token != NULL && index < maxLen) {
    raw[index++] = atoi(token);
    token = strtok(NULL, ",");
  }

  irsend.sendRaw(raw, index, 38);
}




void fileOptions(String filename) {
  const String opts[] = {"Run", "Rename", "Delete", "Info"};
  int optCount = 4, optIndex = 0;

  while (true) {
    u8g2.clearBuffer();
    u8g2.setFont(u8g2_font_6x10_tf);
    u8g2.drawStr(0, 10, filename.c_str());

    // عرض القايمة بخط أوضح وحجم أكبر
    for (int i = 0; i < optCount; i++) {
      int y = 22 + i * 12;
      if (i == optIndex) {
        u8g2.drawBox(0, y - 10, 128, 12);
        u8g2.setDrawColor(0);
      } else {
        u8g2.setDrawColor(1);
      }
      u8g2.setCursor(4, y);
      u8g2.print(opts[i]);
    }
    u8g2.setDrawColor(1);
    u8g2.sendBuffer();

    // التنقل
    if (digitalRead(BTN_UP) == LOW) {
      optIndex = (optIndex + optCount - 1) % optCount;
      delay(200);
    }
    if (digitalRead(BTN_DOWN) == LOW) {
      optIndex = (optIndex + 1) % optCount;
      delay(200);
    }

    // تنفيذ الاختيار
    if (digitalRead(BTN_SELECT) == LOW) {
      delay(200); while (digitalRead(BTN_SELECT) == LOW);
      String selected = opts[optIndex];

      if (selected == "Run") {
        File f = SD.open("/" + filename);
        if (f) {
          String raw = f.readStringUntil('\n'); f.close();
          replayRaw(raw.c_str());
          showMessage("Replayed");
        }
      }

      else if (selected == "Rename") {
        String newname = inputName();
        if (newname != "") {
          SD.rename("/" + filename, "/" + newname + ".ir");
          showMessage("Renamed");
          filename = newname + ".ir";
        } else showMessage("Invalid");
      }

      else if (selected == "Delete") {
        SD.remove("/" + filename);
        showMessage("Deleted");
        delay(800);
        break;
      }

      else if (selected == "Info") {
        File f = SD.open("/" + filename);
        if (!f) {
          showMessage("Can't open");
          continue;
        }

        std::vector<String> lines;
        while (f.available()) {
          String line = f.readStringUntil('\n');
          line.trim();
          lines.push_back(line);
        }
        f.close();

        int scroll = 0;
        const int visibleLines = 5;
        int totalLines = lines.size();

        while (true) {
          u8g2.clearBuffer();
          u8g2.setFont(u8g2_font_6x10_tf);
          u8g2.drawStr(0, 10, "Content:");

          // عرض السطور
          for (int i = 0; i < visibleLines; i++) {
            int index = scroll + i;
            if (index < totalLines) {
              u8g2.drawStr(0, 22 + i * 10, lines[index].c_str());
            }
          }

          // Scroll bar
          if (totalLines > visibleLines) {
            int scrollbarHeight = 40;
            int barY = 22;
            int barX = 124;
            int barH = (visibleLines * scrollbarHeight) / totalLines;
            int barPos = (scroll * scrollbarHeight) / totalLines;
            u8g2.drawFrame(barX, barY, 4, scrollbarHeight);
            u8g2.drawBox(barX, barY + barPos, 4, barH);
          }

          u8g2.sendBuffer();

          if (digitalRead(BTN_DOWN) == LOW && scroll + visibleLines < totalLines) {
            scroll++;
            delay(150);
          }
          if (digitalRead(BTN_UP) == LOW && scroll > 0) {
            scroll--;
            delay(150);
          }
          if (digitalRead(BTN_BACK) == LOW) {
            delay(200); while (digitalRead(BTN_BACK) == LOW);
            break;
          }
        }
      }
    }

    if (digitalRead(BTN_BACK) == LOW) {
      delay(200); while (digitalRead(BTN_BACK) == LOW);
      break;
    }
  }

  listIRFiles();  // عرض الملفات بعد الخروج
}



void listIRFiles() {
  String irFileList[20];
  int irFileCount = 0;
  int selectedIndex = 0, viewOffset = 0;

  loading();
  delay(500);

  File dir = SD.open("/");
  File entry;
  while ((entry = dir.openNextFile())) {
    if (!entry.isDirectory()) {
      String name = String(entry.name());
      if (name.endsWith(".ir") && irFileCount < 20) {
        irFileList[irFileCount++] = name;
      }
    }
    entry.close();
  }
  dir.close();

  if (irFileCount == 0) {
    showMessage("No files");
    delay(1000);
    inIrSubmenu = false;
    
    return;
  }

  const int itemHeight = 14;
  const int visibleItems = 4;

  while (true) {
    u8g2.clearBuffer();
    u8g2.setFont(u8g2_font_6x10_tf);

    for (int i = 0; i < visibleItems; i++) {
      int fi = viewOffset + i;
      if (fi >= irFileCount) break;

      int y = i * itemHeight + 14;

      if (fi == selectedIndex) {
        u8g2.setDrawColor(1);
        u8g2.drawRBox(0, y - 11, 128, itemHeight, 3);  // شكل احترافي
        u8g2.setDrawColor(0);
      } else {
        u8g2.setDrawColor(1);
      }

      u8g2.setCursor(6, y - 2);
      u8g2.print(irFileList[fi]);
    }

    u8g2.sendBuffer();

    if (digitalRead(BTN_SELECT) == LOW) {
      delay(200); while(digitalRead(BTN_SELECT)==LOW);
      fileOptions(irFileList[selectedIndex]);
      break;
    }

    if (digitalRead(BTN_BACK) == LOW) {
      delay(200); inIrSubmenu = false;  break;
    }

    if (digitalRead(BTN_UP) == LOW) {
      if (selectedIndex > 0) selectedIndex--;
      if (selectedIndex < viewOffset) viewOffset--;
      delay(150);
    }

    if (digitalRead(BTN_DOWN) == LOW) {
      if (selectedIndex < irFileCount - 1) selectedIndex++;
      if (selectedIndex > viewOffset + visibleItems - 1) viewOffset++;
      delay(150);
    }
  }
}



